---
title: "Link Account"
description: "Link user wallets to Polymarket to obtain trading credentials"
---

Account linking creates Polymarket CLOB API credentials for a user's wallet. This is a **one-time setup** required before placing orders. After linking, credentials should be stored in your database for subsequent order placement.

## Overview

The linking flow has two steps:

1. **Prepare** - Server generates an EIP-712 payload for the user to sign
2. **Complete** - User signs the payload, server derives Polymarket credentials

```
┌─────────────────────────────────────────────────────────────┐
│  Your App                                    Dome Server    │
│                                                             │
│  POST /link/prepare ─────────────────────────►              │
│  { walletAddress, walletType }                              │
│                                                             │
│                                 ◄─────────────────────────  │
│       { sessionId, eip712Payload, safeInfo? }               │
│                                                             │
│  [User signs EIP-712 payload in wallet]                     │
│                                                             │
│  POST /link/complete ────────────────────────►              │
│  { sessionId, signature }                                   │
│                                                             │
│                                 ◄─────────────────────────  │
│  { credentials, signerAddress, safeAddress? }               │
└─────────────────────────────────────────────────────────────┘
```

## When to Use Direct Endpoints vs SDK

| Use Case | Recommendation |
|----------|----------------|
| Server-side with full wallet access | SDK `linkUser()` method |
| TEE/Enclave environments | Direct endpoints |
| Mobile with on-device signing (Privy) | Direct endpoints |
| Custom signing workflows | Direct endpoints |

---

## SDK Examples

The SDK handles the two-step flow automatically with a single `linkUser()` call.

### EOA Wallet (Privy Embedded)

```typescript
import { PolymarketRouter, createPrivySignerFromEnv } from '@dome-api/sdk';

const router = new PolymarketRouter({
  chainId: 137,
  apiKey: process.env.DOME_API_KEY,
});

// Create signer for Privy embedded wallet
const signer = createPrivySignerFromEnv(walletId, walletAddress);

// Link user - handles prepare + sign + complete internally
const credentials = await router.linkUser({
  userId: 'user-123',
  signer,
  walletType: 'eoa',
});

// Store these credentials in your database
console.log('API Key:', credentials.apiKey);
console.log('API Secret:', credentials.apiSecret);
console.log('Passphrase:', credentials.apiPassphrase);
```

### Safe Wallet (External Wallets)

```typescript
import { PolymarketRouter } from '@dome-api/sdk';

const router = new PolymarketRouter({
  chainId: 137,
  apiKey: process.env.DOME_API_KEY,
});

// Create signer for external wallet (MetaMask, Rabby, etc.)
const signer = {
  getAddress: async () => walletAddress,
  signTypedData: async (payload) => {
    return await externalWallet.signTypedData(payload);
  },
};

// Link user with Safe wallet
const result = await router.linkUser({
  userId: 'user-123',
  signer,
  walletType: 'safe',
  autoDeploySafe: true,
});

// Store credentials and Safe address
console.log('API Key:', result.credentials.apiKey);
console.log('Safe Address:', result.safeAddress);
```

---

## Direct Endpoint Examples

Use the direct endpoints when you need control over the signing step, such as in TEE environments or mobile apps with on-device signing.

### Endpoint URLs

| Environment | Base URL |
|-------------|----------|
| Production | `https://api.domeapi.io/v1/polymarket` |
| Development | `http://localhost:3000` |

### Headers

All requests require:

```
Content-Type: application/json
```

### Step 1: Prepare Session

**`POST /link/prepare`**

Request the EIP-712 payload that the user needs to sign.

<CodeGroup>

```bash cURL
curl -X POST https://api.domeapi.io/v1/polymarket/link-prepare \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "linkPrepare",
    "id": "req-1",
    "params": {
      "walletAddress": "0x1234567890123456789012345678901234567890",
      "walletType": "eoa"
    }
  }'
```

```typescript TypeScript
const response = await fetch('https://api.domeapi.io/v1/polymarket/link-prepare', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    jsonrpc: '2.0',
    method: 'linkPrepare',
    id: 'req-1',
    params: {
      walletAddress: '0x1234567890123456789012345678901234567890',
      walletType: 'eoa',
    },
  }),
});

const data = await response.json();
const { sessionId, eip712Payload } = data.result;
```

```python Python
import requests

response = requests.post(
    'https://api.domeapi.io/v1/polymarket/link-prepare',
    json={
        'jsonrpc': '2.0',
        'method': 'linkPrepare',
        'id': 'req-1',
        'params': {
            'walletAddress': '0x1234567890123456789012345678901234567890',
            'walletType': 'eoa',
        },
    },
)

data = response.json()
session_id = data['result']['sessionId']
eip712_payload = data['result']['eip712Payload']
```

</CodeGroup>

**Request Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `walletAddress` | `string` | Yes | - | User's EOA wallet address (0x...) |
| `walletType` | `"eoa" \| "safe"` | No | `"eoa"` | Wallet type |
| `autoDeploySafe` | `boolean` | No | `true` | Auto-deploy Safe if not deployed (only for `walletType: "safe"`) |
| `chainId` | `number` | No | `137` | Chain ID (137 = Polygon mainnet) |

**Success Response:**

```json
{
  "jsonrpc": "2.0",
  "id": "req-1",
  "result": {
    "sessionId": "550e8400-e29b-41d4-a716-446655440000",
    "expiresAt": 1704067800,
    "eip712Payload": {
      "domain": {
        "name": "ClobAuthDomain",
        "version": "1",
        "chainId": 137
      },
      "types": {
        "ClobAuth": [
          { "name": "address", "type": "address" },
          { "name": "timestamp", "type": "string" },
          { "name": "nonce", "type": "uint256" },
          { "name": "message", "type": "string" }
        ]
      },
      "primaryType": "ClobAuth",
      "message": {
        "address": "0x1234567890123456789012345678901234567890",
        "timestamp": "1704067200",
        "nonce": 0,
        "message": "This message attests that I control the given wallet"
      }
    }
  }
}
```

**Safe Wallet Response (includes `safeInfo`):**

```json
{
  "jsonrpc": "2.0",
  "id": "req-1",
  "result": {
    "sessionId": "550e8400-e29b-41d4-a716-446655440000",
    "expiresAt": 1704067800,
    "eip712Payload": { ... },
    "safeInfo": {
      "safeAddress": "0xABCD...",
      "isDeployed": false,
      "wasDeployed": false,
      "hasAllowances": false,
      "allowancesMissing": ["CTF_EXCHANGE", "NEG_RISK_CTF_EXCHANGE", "NEG_RISK_ADAPTER"]
    }
  }
}
```

### Step 2: Sign the EIP-712 Payload

Sign the `eip712Payload` using your wallet. The exact method depends on your environment:

<CodeGroup>

```typescript Privy (TEE/Mobile)
// In Privy TEE environment
const signature = await privy.signTypedData({
  walletId,
  typedData: eip712Payload,
});
```

```typescript ethers.js
// Using ethers.js signer
const signature = await signer._signTypedData(
  eip712Payload.domain,
  eip712Payload.types,
  eip712Payload.message
);
```

```typescript viem
// Using viem
const signature = await walletClient.signTypedData({
  domain: eip712Payload.domain,
  types: eip712Payload.types,
  primaryType: eip712Payload.primaryType,
  message: eip712Payload.message,
});
```

```javascript MetaMask (Browser)
// Using MetaMask in browser
const signature = await ethereum.request({
  method: 'eth_signTypedData_v4',
  params: [walletAddress, JSON.stringify(eip712Payload)],
});
```

</CodeGroup>

### Step 3: Complete Session

**`POST /link/complete`**

Submit the signature to derive Polymarket credentials.

<CodeGroup>

```bash cURL
curl -X POST https://api.domeapi.io/v1/polymarket/link-complete \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "linkComplete",
    "id": "req-2",
    "params": {
      "sessionId": "550e8400-e29b-41d4-a716-446655440000",
      "signature": "0x1234...abcd"
    }
  }'
```

```typescript TypeScript
const response = await fetch('https://api.domeapi.io/v1/polymarket/link-complete', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    jsonrpc: '2.0',
    method: 'linkComplete',
    id: 'req-2',
    params: {
      sessionId: sessionId,
      signature: signature,
    },
  }),
});

const data = await response.json();
const { credentials, signerAddress, safeAddress } = data.result;

// Store credentials in your database
await db.storeCredentials(userId, {
  apiKey: credentials.apiKey,
  apiSecret: credentials.apiSecret,
  apiPassphrase: credentials.apiPassphrase,
  signerAddress,
  safeAddress, // Only present for Safe wallets
});
```

```python Python
import requests

response = requests.post(
    'https://api.domeapi.io/v1/polymarket/link-complete',
    json={
        'jsonrpc': '2.0',
        'method': 'linkComplete',
        'id': 'req-2',
        'params': {
            'sessionId': session_id,
            'signature': signature,
        },
    },
)

data = response.json()
credentials = data['result']['credentials']
signer_address = data['result']['signerAddress']

# Store credentials in your database
db.store_credentials(
    user_id,
    api_key=credentials['apiKey'],
    api_secret=credentials['apiSecret'],
    api_passphrase=credentials['apiPassphrase'],
)
```

</CodeGroup>

**Request Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `sessionId` | `string` | Yes | Session ID from `/link/prepare` response |
| `signature` | `string` | Yes | EIP-712 signature (0x-prefixed hex) |

**Success Response:**

```json
{
  "jsonrpc": "2.0",
  "id": "req-2",
  "result": {
    "success": true,
    "credentials": {
      "apiKey": "ak_...",
      "apiSecret": "as_...",
      "apiPassphrase": "ap_..."
    },
    "signerAddress": "0x1234567890123456789012345678901234567890"
  }
}
```

**Safe Wallet Response (includes `safeAddress`):**

```json
{
  "jsonrpc": "2.0",
  "id": "req-2",
  "result": {
    "success": true,
    "credentials": {
      "apiKey": "ak_...",
      "apiSecret": "as_...",
      "apiPassphrase": "ap_..."
    },
    "signerAddress": "0x1234567890123456789012345678901234567890",
    "safeAddress": "0xABCD..."
  }
}
```

---

## Set Allowances (Safe Wallets Only)

**`POST /link/setAllowances`**

For Safe wallets, USDC allowances must be set before trading. If `/link/prepare` returns `hasAllowances: false` in the `safeInfo`, call this endpoint to set the required approvals.

<Note>
This endpoint only works for Safe wallets that are already deployed. If `isDeployed: false`, the Safe must be deployed first (either by funding it or enabling `autoDeploySafe: true` in `/link/prepare`).
</Note>

<CodeGroup>

```bash cURL
curl -X POST https://api.domeapi.io/v1/polymarket/link-set-allowances \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "setAllowances",
    "id": "req-3",
    "params": {
      "walletAddress": "0x1234567890123456789012345678901234567890",
      "signature": "0x1234...abcd",
      "chainId": 137
    }
  }'
```

```typescript TypeScript
// First, sign a message to prove ownership of the EOA
const message = "Approve USDC allowances for trading";
const signature = await signer.signMessage(message);

const response = await fetch('https://api.domeapi.io/v1/polymarket/link-set-allowances', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    jsonrpc: '2.0',
    method: 'setAllowances',
    id: 'req-3',
    params: {
      walletAddress: userWalletAddress,
      signature: signature,
      chainId: 137,
    },
  }),
});

const data = await response.json();

if (data.result?.success) {
  console.log('Allowances set for:', data.result.safeAddress);
  console.log('Allowances set:', data.result.allowancesSet);
}
```

```python Python
import requests

response = requests.post(
    'https://api.domeapi.io/v1/polymarket/link-set-allowances',
    json={
        'jsonrpc': '2.0',
        'method': 'setAllowances',
        'id': 'req-3',
        'params': {
            'walletAddress': wallet_address,
            'signature': signature,
            'chainId': 137,
        },
    },
)

data = response.json()
if data.get('result', {}).get('success'):
    print(f"Allowances set for: {data['result']['safeAddress']}")
```

</CodeGroup>

**Request Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `walletAddress` | `string` | Yes | - | User's EOA wallet address (the Safe owner) |
| `signature` | `string` | Yes | - | Signature proving ownership of the EOA |
| `chainId` | `number` | No | `137` | Chain ID (137 = Polygon mainnet) |

**Success Response:**

```json
{
  "jsonrpc": "2.0",
  "id": "req-3",
  "result": {
    "success": true,
    "safeAddress": "0xABCD...",
    "allowancesSet": ["CTF_EXCHANGE", "NEG_RISK_CTF_EXCHANGE", "NEG_RISK_ADAPTER"],
    "transactionId": "0x..."
  }
}
```

**Response when allowances already set:**

```json
{
  "jsonrpc": "2.0",
  "id": "req-3",
  "result": {
    "success": true,
    "safeAddress": "0xABCD...",
    "allowancesSet": []
  }
}
```

---

## Complete Direct Endpoint Example

Full example for TEE/mobile environments:

```typescript
// 1. Prepare - get EIP-712 payload
const prepareResponse = await fetch('https://api.domeapi.io/v1/polymarket/link-prepare', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    jsonrpc: '2.0',
    method: 'linkPrepare',
    id: crypto.randomUUID(),
    params: {
      walletAddress: userWalletAddress,
      walletType: 'eoa',
    },
  }),
});

const prepareData = await prepareResponse.json();

if (prepareData.error) {
  throw new Error(`Prepare failed: ${prepareData.error.message}`);
}

const { sessionId, eip712Payload } = prepareData.result;

// 2. Sign - user signs in their wallet (TEE, mobile, etc.)
const signature = await signEip712InTEE(eip712Payload);

// 3. Complete - exchange signature for credentials
const completeResponse = await fetch('https://api.domeapi.io/v1/polymarket/link-complete', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    jsonrpc: '2.0',
    method: 'linkComplete',
    id: crypto.randomUUID(),
    params: {
      sessionId,
      signature,
    },
  }),
});

const completeData = await completeResponse.json();

if (completeData.error) {
  throw new Error(`Complete failed: ${completeData.error.message}`);
}

const { credentials, signerAddress } = completeData.result;

// 4. Store credentials for future order placement
await database.savePolymarketCredentials(userId, {
  apiKey: credentials.apiKey,
  apiSecret: credentials.apiSecret,
  apiPassphrase: credentials.apiPassphrase,
  signerAddress,
});

console.log('Account linked successfully!');
```

---

## Health Check

**`GET /link/health`**

Check the link service status.

```bash
curl https://api.domeapi.io/v1/polymarket/link-health
```

**Response:**

```json
{
  "status": "ok",
  "service": "link",
  "region": "us-east-1",
  "activeSessions": 5,
  "timestamp": 1704067200000
}
```

---

## Error Handling

### Error Codes

| Code | Name | Description |
|------|------|-------------|
| `-32600` | `INVALID_REQUEST` | Malformed request or validation error |
| `-32602` | `INVALID_PARAMS` | Invalid parameters |
| `2001` | `INVALID_WALLET_ADDRESS` | Invalid wallet address format |
| `2002` | `SESSION_NOT_FOUND` | Session ID not found |
| `2003` | `SESSION_EXPIRED` | Session expired (10 minute TTL) |
| `2004` | `INVALID_SIGNATURE` | Signature verification failed |
| `2005` | `CREDENTIAL_DERIVATION_FAILED` | Failed to derive credentials from Polymarket |
| `2006` | `SAFE_DEPLOYMENT_FAILED` | Safe wallet deployment failed |
| `2007` | `SAFE_NOT_DEPLOYED` | Safe wallet not deployed and autoDeploySafe=false |
| `2009` | `ALLOWANCE_SET_FAILED` | Failed to set allowances on Safe wallet |

### Error Response Example

```json
{
  "jsonrpc": "2.0",
  "id": "req-1",
  "error": {
    "code": 2003,
    "message": "Session expired",
    "data": {
      "reason": "Session expired",
      "sessionId": "550e8400-e29b-41d4-a716-446655440000"
    }
  }
}
```

### Handling Errors

```typescript
const response = await fetch('https://api.domeapi.io/v1/polymarket/link-complete', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ ... }),
});

const data = await response.json();

if (data.error) {
  switch (data.error.code) {
    case 2002:
    case 2003:
      // Session expired or not found - restart flow
      await startLinkFlow();
      break;
    case 2004:
      // Invalid signature - user may have signed wrong data
      console.error('Signature verification failed');
      break;
    case 2005:
      // Polymarket API error - retry or contact support
      console.error('Credential derivation failed:', data.error.data?.reason);
      break;
    default:
      console.error('Link error:', data.error.message);
  }
}
```

---

## Session Lifecycle

- Sessions expire after **10 minutes**
- Each session can only be completed **once**
- After successful completion, credentials are returned and session is deleted
- If a session expires, call `/link/prepare` again to start a new session

---

## Security Considerations

1. **Store credentials securely** - Encrypt `apiSecret` and `apiPassphrase` at rest
2. **Session IDs are single-use** - Cannot replay `/link/complete` with same sessionId
3. **Signature verification** - Server verifies the signature matches the wallet address
4. **No private keys transmitted** - Only the signature is sent to the server

---

## Next Steps

After linking, use the credentials to [place orders](/order-router#place-orders):

```typescript
const order = await router.placeOrder(
  {
    userId: 'user-123',
    marketId: '104173557214744537570424345347209544585775842950109756851652855913015295701992',
    side: 'buy',
    size: 100,
    price: 0.50,
    signer,
  },
  credentials
);
```

Or call the [placeOrder endpoint](/order-router#rest-endpoint) directly with the credentials.
